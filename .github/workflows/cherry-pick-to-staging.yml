name: Cherry-pick to Staging

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  cherry-pick:
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get merge commit SHA
        id: get-merge-commit
        run: |
          MERGE_COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          echo "merge_commit_sha=${MERGE_COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "Merge commit SHA: ${MERGE_COMMIT_SHA}"

      - name: Create cherry-pick branch
        id: create-branch
        run: |
          # stagingãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚’å–å¾—
          git fetch origin staging

          # ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆï¼ˆå…ƒã®PRã®ãƒ–ãƒ©ãƒ³ãƒåã‚’ä½¿ç”¨ï¼‰
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          NEW_BRANCH="cherry-pick/${SOURCE_BRANCH}-to-staging-${TIMESTAMP}"

          echo "new_branch=${NEW_BRANCH}" >> $GITHUB_OUTPUT
          echo "source_branch=${SOURCE_BRANCH}" >> $GITHUB_OUTPUT

          # stagingã‹ã‚‰æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b "${NEW_BRANCH}" origin/staging
          echo "Created branch: ${NEW_BRANCH}"

      - name: Cherry-pick commits
        id: cherry-pick
        run: |
          MERGE_COMMIT="${{ steps.get-merge-commit.outputs.merge_commit_sha }}"

          echo "Cherry-picking commit: ${MERGE_COMMIT}"

          # ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          if git cherry-pick -m 1 "${MERGE_COMMIT}" 2>&1 | tee /tmp/cherry-pick-output.txt; then
            echo "Cherry-pick successful"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "is_empty=false" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            
            # ç©ºã®ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãŒæ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹ï¼‰ã‹ã©ã†ã‹ã‚’ç¢ºèª
            if grep -q "The previous cherry-pick is now empty" /tmp/cherry-pick-output.txt; then
              echo "Cherry-pick resulted in empty commit (changes already in staging)"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "is_empty=true" >> $GITHUB_OUTPUT
              git cherry-pick --skip
            else
              echo "Cherry-pick failed with conflicts"
              echo "success=false" >> $GITHUB_OUTPUT
              echo "is_empty=false" >> $GITHUB_OUTPUT
              
              # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆã®æƒ…å ±ã‚’è¨˜éŒ²
              git status > /tmp/conflict-status.txt
              echo "conflict_info<<EOF" >> $GITHUB_OUTPUT
              cat /tmp/conflict-status.txt >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              
              # ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯ã‚’ä¸­æ­¢
              git cherry-pick --abort
              exit 1
            fi
          fi

      - name: Comment on empty commit
        if: steps.cherry-pick.outputs.success == 'true' && steps.cherry-pick.outputs.is_empty == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `â„¹ï¸ stagingãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚\n\nã“ã®å¤‰æ›´ã¯æ—¢ã«stagingãƒ–ãƒ©ãƒ³ãƒã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯ã®å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`
            });

      - name: Push branch
        if: steps.cherry-pick.outputs.success == 'true' && steps.cherry-pick.outputs.is_empty == 'false'
        run: |
          NEW_BRANCH="${{ steps.create-branch.outputs.new_branch }}"
          git push origin "${NEW_BRANCH}"
          echo "Pushed branch: ${NEW_BRANCH}"

      - name: Create Pull Request
        if: steps.cherry-pick.outputs.success == 'true' && steps.cherry-pick.outputs.is_empty == 'false'
        id: create-pr
        run: |
          SOURCE_BRANCH="${{ steps.create-branch.outputs.source_branch }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          MERGE_COMMIT_SHA="${{ steps.get-merge-commit.outputs.merge_commit_sha }}"

          # PRã®æœ¬æ–‡ã‚’ä½œæˆ
          PR_BODY=$(cat <<EOF
          ## ğŸ’ Cherry-pick from main to staging

          ã“ã®PRã¯ã€mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ã‚’è‡ªå‹•çš„ã«stagingãƒ–ãƒ©ãƒ³ãƒã«åæ˜ ã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

          ### å…ƒã®PRæƒ…å ±
          - **å…ƒã®PR**: #${PR_NUMBER}
          - **å…ƒã®ãƒ–ãƒ©ãƒ³ãƒ**: \`${SOURCE_BRANCH}\`
          - **ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆ**: \`${MERGE_COMMIT_SHA}\`

          ### ç¢ºèªäº‹é …
          - [ ] ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯ã•ã‚ŒãŸå¤‰æ›´å†…å®¹ã‚’ç¢ºèª
          - [ ] ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒãªã„ã“ã¨ã‚’ç¢ºèª
          - [ ] ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

          ---
          _ã“ã®PRã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_
          EOF
          )

          # gh pr createã§PRã‚’ä½œæˆ
          PR_URL=$(gh pr create \
            --title "[Staging] ${PR_TITLE}" \
            --body "${PR_BODY}" \
            --base staging \
            --head "${{ steps.create-branch.outputs.new_branch }}")

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "Pull Request created: ${PR_URL}"

          # PRã®ç•ªå·ã‚’æŠ½å‡º
          PR_NUM=$(echo "${PR_URL}" | grep -oE '[0-9]+$')
          echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT

      - name: Comment on original PR
        if: steps.cherry-pick.outputs.success == 'true' && steps.cherry-pick.outputs.is_empty == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            const newPrNumber = '${{ steps.create-pr.outputs.pr_number }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `âœ… stagingãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ: #${newPrNumber}`
            });

      - name: Comment on failure
        if: failure() && steps.cherry-pick.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            const conflictInfo = `${{ steps.cherry-pick.outputs.conflict_info }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `âš ï¸ stagingãƒ–ãƒ©ãƒ³ãƒã¸ã®è‡ªå‹•ãƒã‚§ãƒªãƒ¼ãƒ”ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚

            ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•ã§ã®ãƒãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚

            ### æ‰‹å‹•ã§ã®ãƒãƒ¼ã‚¸æ‰‹é †
            \`\`\`bash
            git fetch origin
            git checkout -b cherry-pick-manual origin/staging
            git cherry-pick -m 1 ${{ steps.get-merge-commit.outputs.merge_commit_sha }}
            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±º
            git add .
            git cherry-pick --continue
            git push origin cherry-pick-manual
            # ãã®å¾Œã€stagingã¸ã®PRã‚’ä½œæˆ
            \`\`\`

            <details>
            <summary>ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæƒ…å ±</summary>

            \`\`\`
            ${conflictInfo}
            \`\`\`
            </details>`
            });
